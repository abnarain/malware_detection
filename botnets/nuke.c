/*
VM dies by successive calls of kill and exit in the child process!
Interesting code for Virtualbox, while debugging Mirai
*/
#include<stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <signal.h>

int main(){
	printf("start %d\n",getpid());
	int pid1, pid2;
	pid1=fork();
	if (pid1==-1 || pid1 > 0) {
		printf("pid-1,>0, %d now return\n",getpid());
		return;
	}
	
	pid2 = fork();
	if (pid2 == -1) {
        	printf("pid2==-1 %d now exit\n",getpid());
	        exit(0);
        }
	else if (pid2 == 0){
        sleep(1);
        	printf("in pid2==0 %d will kill and exit\n",getpid());
	        kill(getppid(), 9);
	        exit(0);
	}
	else
	{
		printf("before exit in else %d\n",getpid());
		exit(0);
	}
	
	printf("function end %d\n",getpid());

}
